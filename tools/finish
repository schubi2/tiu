#!/bin/bash

source $(dirname $0)/logging

ROOTDIR=/mnt

# Create /var/log/journal...
run "mkdir -p ${ROOTDIR}/var/log/journal"
run "chmod 2755 ${ROOTDIR}/var/log/journal"
run "chroot ${ROOTDIR} chown root:systemd-journal /var/log/journal"

if [ -d ${ROOTDIR}/os ]; then
    # Switch subvolume back to read-only
    run "btrfs property set ${ROOTDIR}/os/.snapshots/1/snapshot ro true"
fi

run "umount -R ${ROOTDIR}/usr"

# Umount everything
run "umount -R ${ROOTDIR}"
